<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Świąteczne losowanie</title>
</head>
<body>
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-analytics.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries
  
    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyB2jdkHNxzsjFl01ryROP1bKpTINsqEEf0",
      authDomain: "family-drawing.firebaseapp.com",
      projectId: "family-drawing",
      storageBucket: "family-drawing.appspot.com",
      messagingSenderId: "663235592596",
      appId: "1:663235592596:web:ab7a393ed45a01e93f0f81",
      measurementId: "G-ZNY5CLVB1X",
      databaseURL: "https://family-drawing-default-rtdb.europe-west1.firebasedatabase.app"
    };
  
    // Initialize Firebase ---------------------------------------------------------------
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const database = getDatabase(app);
  

    // Handle form -----------------------------------------------------------------------
    let drawingForm = document.getElementById("drawing-form");
    drawingForm.addEventListener("submit", (e) => {
      e.preventDefault();
      
      let personListSelect = document.getElementById("person-list");
      console.log('Selected value: ' + personListSelect.value);
      console.log('Selected text: ' + personListSelect.options[personListSelect.selectedIndex].text);

      // Getting person list
      const personsRef = ref(database, 'persons');
      onValue(personsRef, (snapshot) => {
        const personList = snapshot.val();
        console.log('Persons data:');
        console.table(personList);

        // Getting drawing list
        const drawingsRef = ref(database, 'drawings/2023');
        onValue(drawingsRef, (snapshot) => {
          const drawingList = snapshot.val();
          console.log('Drawings data:');
          console.table(drawingList);

          // Getting drawn list
          let drawnPersons = [];
          for (let i = 0; i < drawingList.length; i++) {
            let indexOfComma = drawingList[i].indexOf(">");
            drawnPersons[i] = drawingList[i].substring(indexOfComma + 1);
            console.log("drawnPerson[i]: " + drawnPersons[i]);
          }
          console.log("Drawns:");
          console.table(drawnPersons);

          // Getting free persons list
          let freePersons = [];
          let freePersonsCount = 0;
          for (let j = 0; j < personList.length; j++) {
            for (let k = 0; k < drawnPersons.length; k++) {
              if (personList[j] != drawnPersons[k]) {
                freePersons[freePersonsCount] = personList[j];
                freePersonsCount++;
              }
            }
          }
          console.log("Free persons:");
          console.table(freePersons);

          let randomNumber = Math.floor((Math.random() * freePersons.length - 1) + 1);
          let randomlyDrawnPerson = freePersons[randomNumber];
          console.log("randomNumber: " + randomNumber + ", randomlyDrawnPerson: " + randomlyDrawnPerson);
        });
      });

    });
  </script>

  <h2>Świąteczne losowanie</h2>

  <form action="" id="drawing-form">
    <h4>Kto losuje?</h4>

    <select id="person-list">
      <option value="jola">Jola</option>
      <option value="grzes">Grześ</option>
      <option value="magda">Magda</option>
      <option value="kamil">Kamil</option>
    </select>

    <button type="submit">Losuj</button>
  </form>
</body>
</html>